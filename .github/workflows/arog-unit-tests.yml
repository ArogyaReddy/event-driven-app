name: ðŸ§ª AROG - Unit Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“š Install Dependencies
        run: npm ci
        
      - name: ðŸ§ª Run Unit Tests
        run: npm test -- --coverage --verbose
        
      - name: ðŸ“Š Coverage Report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-tests-coverage
          
      - name: âœ… Check Coverage Thresholds
        run: |
          node -e "
          const coverage = require('./coverage/coverage-summary.json');
          const total = coverage.total;
          const threshold = 70;
          
          const metrics = ['lines', 'statements', 'functions', 'branches'];
          let failed = false;
          
          metrics.forEach(metric => {
            const pct = total[metric].pct;
            console.log(\`\${metric}: \${pct}%\`);
            if (pct < threshold) {
              console.error(\`âŒ \${metric} coverage (\${pct}%) below threshold (\${threshold}%)\`);
              failed = true;
            }
          });
          
          if (failed) {
            process.exit(1);
          }
          console.log('âœ… All coverage thresholds met!');
          "
          
      - name: ðŸ’¬ Comment PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **AROG Unit Tests Failed**\n\nPlease check the test results and fix failing tests.\n\n[View Details](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')'
            })
