name: ğŸ“Š AROG - PR Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

jobs:
  pr-analysis:
    name: Comprehensive PR Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“Š Analyze PR Complexity
        id: analyze
        run: |
          # Get PR stats
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $1} END {print sum}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $2} END {print sum}')
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          
          # Calculate complexity score
          TOTAL_CHANGES=$((LINES_ADDED + LINES_DELETED))
          
          if [ $FILES_CHANGED -gt 20 ] || [ $TOTAL_CHANGES -gt 500 ]; then
            echo "risk=HIGH" >> $GITHUB_OUTPUT
          elif [ $FILES_CHANGED -gt 10 ] || [ $TOTAL_CHANGES -gt 250 ]; then
            echo "risk=MEDIUM" >> $GITHUB_OUTPUT
          else
            echo "risk=LOW" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ” Check for Breaking Changes
        run: |
          # Check for breaking changes
          git diff origin/${{ github.base_ref }}...HEAD -- package.json > package-diff.txt
          
          if grep -q '"version"' package-diff.txt; then
            echo "Version bump detected"
          fi
          
      - name: ğŸ“ Generate PR Review
        run: |
          node -e "
          const review = {
            filesChanged: ${{ steps.analyze.outputs.files_changed }},
            linesAdded: ${{ steps.analyze.outputs.lines_added }},
            linesDeleted: ${{ steps.analyze.outputs.lines_deleted }},
            risk: '${{ steps.analyze.outputs.risk }}',
            recommendations: []
          };
          
          // Add recommendations based on PR size
          if (review.risk === 'HIGH') {
            review.recommendations.push('âš ï¸ Large PR detected. Consider breaking into smaller PRs');
            review.recommendations.push('ğŸ‘¥ Request additional reviewers for high-risk changes');
          }
          
          if (review.filesChanged > 15) {
            review.recommendations.push('ğŸ“š Many files changed - ensure thorough testing');
          }
          
          if (review.linesAdded > 300) {
            review.recommendations.push('ğŸ§ª Large code addition - verify test coverage');
          }
          
          review.recommendations.push('âœ… Run full test suite before merging');
          review.recommendations.push('ğŸ“– Update documentation if needed');
          
          const fs = require('fs');
          fs.writeFileSync('pr-review.json', JSON.stringify(review, null, 2));
          "
          
      - name: ğŸ’¬ Post PR Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('pr-review.json'));
            
            const riskColor = {
              LOW: 'ğŸŸ¢',
              MEDIUM: 'ğŸŸ¡',
              HIGH: 'ğŸ”´'
            };
            
            let comment = `## ğŸ“Š AROG PR Analysis\n\n`;
            comment += `### ğŸ“ˆ Statistics\n\n`;
            comment += `- **Files Changed:** ${review.filesChanged}\n`;
            comment += `- **Lines Added:** +${review.linesAdded}\n`;
            comment += `- **Lines Deleted:** -${review.linesDeleted}\n`;
            comment += `- **Risk Level:** ${riskColor[review.risk]} ${review.risk}\n\n`;
            
            comment += `### ğŸ’¡ Recommendations\n\n`;
            review.recommendations.forEach(rec => {
              comment += `- ${rec}\n`;
            });
            
            comment += `\n---\n### ğŸ¤– Automated Checks Status\n\n`;
            comment += `- ğŸ§ª Unit Tests: Pending\n`;
            comment += `- ğŸ­ E2E Tests: Pending\n`;
            comment += `- ğŸ”’ Security: Pending\n`;
            comment += `- âš¡ Performance: Pending\n`;
            comment += `- ğŸ—ï¸ Build: Pending\n\n`;
            comment += `*AROG will update this comment as checks complete*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })
